# 管理者ログイン問題の詳細デバッグ手順

## 現在の状況

管理者ログインができない場合、以下の手順で原因を特定してください。

## ステップ1: アプリケーション起動時のログを確認

`AdminPasswordInitializer`クラスを追加しました。アプリケーション起動時に以下の情報が表示されます：

1. 管理者がデータベースに存在するか
2. 現在のパスワードハッシュ
3. パスワード検証結果

アプリケーションを起動して、コンソールに表示されるメッセージを確認してください。

```powershell
java -jar target/appointment-1.0.0.jar
```

## ステップ2: データベースを直接確認

MySQLに接続して、以下のSQLを実行：

```sql
USE clinic_booking_db;

-- 管理者の存在確認
SELECT admin_id, admin_login_id, name, 
       LEFT(password, 30) as password_hash_preview,
       created_at
FROM administrators 
WHERE admin_login_id = 'admin';
```

管理者が存在しない場合は、新規作成が必要です。

## ステップ3: 新しいパスワードハッシュで更新

アプリケーション起動時に表示された新しいハッシュを使用するか、以下の方法でハッシュを生成：

### 方法A: AdminPasswordInitializerの出力を使用

アプリケーション起動時に表示されたSQLをそのまま実行：

```sql
USE clinic_booking_db;
UPDATE administrators SET password = '表示されたハッシュ' WHERE admin_login_id = 'admin';
```

### 方法B: 新しいレコードを作成

```sql
USE clinic_booking_db;

-- 既存のレコードを削除
DELETE FROM administrators WHERE admin_login_id = 'admin';

-- アプリケーション起動時に表示されたINSERT文を実行
-- または、以下のようなハッシュを使用（新しいハッシュは起動時に表示されます）
INSERT INTO administrators (admin_login_id, password, name) 
VALUES ('admin', 'アプリケーション起動時に表示されたハッシュ', 'システム管理者');
```

## ステップ4: 認証プロセスの確認

アプリケーション起動後、ログインページで以下の情報を入力：

- **ログインID**: `admin`
- **パスワード**: `admin`

### ログイン時のエラーメッセージを確認

- "ログインIDまたはパスワードが正しくありません" → 認証プロバイダーの問題
- その他のエラー → ログを確認

## ステップ5: 認証プロバイダーのデバッグ

`CustomAuthenticationProvider`にログを追加して、認証プロセスを確認：

アプリケーションのログレベルをDEBUGに設定（`application.yml`に追加）：

```yaml
logging:
  level:
    com.unknownclinic.appointment.config.CustomAuthenticationProvider: DEBUG
```

## よくある原因と解決方法

### 原因1: パスワードハッシュが一致しない

**解決方法**: アプリケーション起動時に表示された新しいハッシュを使用して更新

### 原因2: 管理者レコードが存在しない

**解決方法**: アプリケーション起動時に表示されたINSERT文を実行

### 原因3: 認証プロバイダーが正しく動作していない

**解決方法**: `CustomAuthenticationProvider`の実装を確認。管理者の認証が先に実行されているか確認。

## クイック修正SQL

最も簡単な方法：

```sql
USE clinic_booking_db;

-- 既存の管理者を削除
DELETE FROM administrators WHERE admin_login_id = 'admin';

-- アプリケーションを一度起動して、新しいハッシュを取得
-- その後、そのハッシュで以下を実行：

-- INSERT INTO administrators (admin_login_id, password, name) 
-- VALUES ('admin', 'アプリ起動時に表示されたハッシュ', 'システム管理者');
```

まずは、アプリケーションを起動して、コンソールに表示されるメッセージを確認してください！
