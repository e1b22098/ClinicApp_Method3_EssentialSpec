<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.unknownclinic.appointment.mapper.BookingMapper">
    
    <resultMap id="BookingResultMap" type="com.unknownclinic.appointment.domain.Booking">
        <id property="bookingId" column="booking_id"/>
        <result property="patientId" column="patient_id"/>
        <result property="businessDate" column="business_date"/>
        <result property="timeSlot" column="time_slot"/>
        <result property="status" column="status"/>
        <result property="createdAt" column="created_at"/>
        <result property="updatedAt" column="updated_at"/>
        <association property="patient" resultMap="com.unknownclinic.appointment.mapper.PatientMapper.PatientResultMap"/>
    </resultMap>

    <resultMap id="BookingWithPatientResultMap" type="com.unknownclinic.appointment.domain.Booking">
        <id property="bookingId" column="booking_id"/>
        <result property="patientId" column="patient_id"/>
        <result property="businessDate" column="business_date"/>
        <result property="timeSlot" column="time_slot"/>
        <result property="status" column="status"/>
        <result property="createdAt" column="created_at"/>
        <result property="updatedAt" column="updated_at"/>
        <association property="patient" javaType="com.unknownclinic.appointment.domain.Patient">
            <id property="patientId" column="patient_id"/>
            <result property="patientNumber" column="patient_number"/>
            <result property="name" column="patient_name"/>
            <result property="phoneNumber" column="phone_number"/>
        </association>
    </resultMap>

    <select id="findByPatientId" resultMap="BookingResultMap">
        SELECT * FROM bookings 
        WHERE patient_id = #{patientId}
        ORDER BY business_date DESC, time_slot ASC
    </select>

    <select id="findByBusinessDate" resultMap="BookingWithPatientResultMap">
        SELECT 
            b.*,
            p.patient_number,
            p.name as patient_name,
            p.phone_number
        FROM bookings b
        INNER JOIN patients p ON b.patient_id = p.patient_id
        WHERE b.business_date = #{businessDate}
        ORDER BY b.time_slot ASC
    </select>

    <select id="findById" resultMap="BookingResultMap">
        SELECT * FROM bookings WHERE booking_id = #{bookingId}
    </select>

    <select id="findByBusinessDateAndTimeSlot" resultMap="BookingResultMap">
        SELECT * FROM bookings 
        WHERE business_date = #{businessDate} AND time_slot = #{timeSlot}
        AND status IN ('PENDING', 'CONFIRMED')
        LIMIT 1
    </select>

    <insert id="insert" useGeneratedKeys="true" keyProperty="bookingId">
        INSERT INTO bookings (patient_id, business_date, time_slot, status)
        VALUES (#{patientId}, #{businessDate}, #{timeSlot}, #{status})
    </insert>

    <update id="update">
        UPDATE bookings
        SET patient_id = #{patientId}, business_date = #{businessDate}, 
            time_slot = #{timeSlot}, status = #{status}
        WHERE booking_id = #{bookingId}
    </update>

    <update id="updateStatus">
        UPDATE bookings
        SET status = #{status}
        WHERE booking_id = #{bookingId}
    </update>

    <delete id="delete">
        DELETE FROM bookings WHERE booking_id = #{bookingId}
    </delete>
</mapper>
