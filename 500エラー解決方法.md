# 500エラー解決方法（予約作成フォーム）

## エラーの原因

予約作成フォーム（`/patient/bookings/new`）で500エラーが発生する場合、以下の原因が考えられます：

1. **データベースに営業日が登録されていない**
2. **データベース接続エラー**
3. **日付フォーマットの問題**

## 解決手順

### ステップ1: アプリケーションのログを確認

アプリケーションを起動しているターミナルまたはログファイルを確認してください。
スタックトレースが表示されているはずです。

### ステップ2: データベースに営業日が存在するか確認

MySQLに接続して、営業日テーブルを確認：

```sql
USE clinic_booking_db;
SELECT * FROM business_days;
```

営業日が存在しない場合は、管理者ページから営業日を追加するか、以下のSQLを実行：

```sql
USE clinic_booking_db;

-- 来月の営業日を追加（例）
INSERT INTO business_days (business_date, is_available) VALUES
(DATE_ADD(CURDATE(), INTERVAL 1 MONTH), TRUE),
(DATE_ADD(CURDATE(), INTERVAL 1 MONTH) + INTERVAL 1 DAY, TRUE),
(DATE_ADD(CURDATE(), INTERVAL 1 MONTH) + INTERVAL 2 DAY, TRUE),
(DATE_ADD(CURDATE(), INTERVAL 1 MONTH) + INTERVAL 3 DAY, TRUE),
(DATE_ADD(CURDATE(), INTERVAL 1 MONTH) + INTERVAL 4 DAY, TRUE);
```

### ステップ3: エラーハンドリングの改善

コードを更新して、エラーメッセージを表示するようにしました。
エラーが発生した場合、フォームにエラーメッセージが表示されます。

### ステップ4: アプリケーションを再起動

コードを更新した場合は、アプリケーションを再ビルド・再起動：

```powershell
mvn install -DskipTests
java -jar target/appointment-1.0.0.jar
```

### ステップ5: 再度アクセス

ブラウザで再度 `/patient/bookings/new` にアクセスしてください。

## よくあるエラーと解決方法

### エラー: "営業日データの取得に失敗しました"

→ データベース接続エラーまたは営業日が存在しない可能性があります。

**解決方法**:
1. MySQLが起動しているか確認
2. `application.yml`のデータベース接続情報を確認
3. 営業日テーブルにデータが存在するか確認

### エラー: 日付フォーマットエラー

→ テンプレートの日付フォーマットの問題（修正済み）

### エラー: NullPointerException

→ データベースから取得したデータがnullの可能性

**解決方法**: 営業日テーブルにデータを追加

## クイック修正

### ステップ1: 営業日データが存在するか確認

```sql
USE clinic_booking_db;
SELECT * FROM business_days;
```

### ステップ2: 営業日が存在しない場合、追加

簡単な方法（`営業日データ追加（簡単版）.sql`を参照）：

```sql
USE clinic_booking_db;

-- 来月の営業日を10日分追加
INSERT INTO business_days (business_date, is_available) 
VALUES 
(DATE_ADD(CURDATE(), INTERVAL 1 MONTH), TRUE),
(DATE_ADD(CURDATE(), INTERVAL 1 MONTH) + INTERVAL 1 DAY, TRUE),
(DATE_ADD(CURDATE(), INTERVAL 1 MONTH) + INTERVAL 2 DAY, TRUE),
(DATE_ADD(CURDATE(), INTERVAL 1 MONTH) + INTERVAL 3 DAY, TRUE),
(DATE_ADD(CURDATE(), INTERVAL 1 MONTH) + INTERVAL 4 DAY, TRUE),
(DATE_ADD(CURDATE(), INTERVAL 1 MONTH) + INTERVAL 5 DAY, TRUE),
(DATE_ADD(CURDATE(), INTERVAL 1 MONTH) + INTERVAL 6 DAY, TRUE),
(DATE_ADD(CURDATE(), INTERVAL 1 MONTH) + INTERVAL 7 DAY, TRUE),
(DATE_ADD(CURDATE(), INTERVAL 1 MONTH) + INTERVAL 8 DAY, TRUE),
(DATE_ADD(CURDATE(), INTERVAL 1 MONTH) + INTERVAL 9 DAY, TRUE)
ON DUPLICATE KEY UPDATE is_available = TRUE;
```

### ステップ3: 再度アクセス

営業日を追加した後、**アプリケーションの再起動は不要**です。ブラウザで再度 `/patient/bookings/new` にアクセスしてください。

もし、アプリケーションのログにエラーが表示される場合は、そのエラーメッセージを確認してください。
